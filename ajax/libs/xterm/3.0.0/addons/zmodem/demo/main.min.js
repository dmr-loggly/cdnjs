"use strict";var term,protocol,socketURL,socket,pid,terminalContainer=document.getElementById("terminal-container"),actionElements={findNext:document.querySelector("#find-next"),findPrevious:document.querySelector("#find-previous")},optionElements={cursorBlink:document.querySelector("#option-cursor-blink"),cursorStyle:document.querySelector("#option-cursor-style"),scrollback:document.querySelector("#option-scrollback"),tabstopwidth:document.querySelector("#option-tabstopwidth"),bellStyle:document.querySelector("#option-bell-style")},colsElement=document.getElementById("cols"),rowsElement=document.getElementById("rows");function setTerminalSize(){var e=parseInt(colsElement.value,10),t=parseInt(rowsElement.value,10),n=document.querySelector(".xterm-viewport"),o=(n.offsetWidth,n.clientWidth,(e*term.charMeasure.width+20).toString()+"px"),r=(t*term.charMeasure.height).toString()+"px";terminalContainer.style.width=o,terminalContainer.style.height=r,term.resize(e,t)}function createTerminal(){for(;terminalContainer.children.length;)terminalContainer.removeChild(terminalContainer.children[0]);(term=new Terminal({cursorBlink:optionElements.cursorBlink.checked,scrollback:parseInt(optionElements.scrollback.value,10),tabStopWidth:parseInt(optionElements.tabstopwidth.value,10)})).on("resize",function(e){if(pid){var t=e.cols,n=e.rows;fetch("/terminals/"+pid+"/size?cols="+t+"&rows="+n,{method:"POST"})}}),protocol="https:"===location.protocol?"wss://":"ws://",socketURL=protocol+location.hostname+(location.port?":"+location.port:"")+"/terminals/",term.open(terminalContainer),term.fit(),setTimeout(function(){colsElement.value=term.cols,rowsElement.value=term.rows,setTerminalSize(),fetch("/terminals?cols="+term.cols+"&rows="+term.rows,{method:"POST"}).then(function(e){e.text().then(function(e){window.pid=e,socketURL+=e,(socket=new WebSocket(socketURL)).onopen=runRealTerminal,socket.onclose=runFakeTerminal,socket.onerror=runFakeTerminal,term.zmodemAttach(socket,{noTerminalWriteOutsideSession:!0}),term.on("zmodemRetract",()=>{start_form.style.display="none",start_form.onsubmit=null}),term.on("zmodemDetect",e=>{function t(){term.detach();let t=e.confirm();("receive"===t.type?_handle_receive_session(t):_handle_send_session(t)).catch(console.error.bind(console)).then(()=>{term.attach(socket)})}_auto_zmodem()?t():(start_form.style.display="",start_form.onsubmit=function(n){start_form.style.display="none",document.getElementById("zmstart_yes").checked?t():e.deny()})})})})},0)}function _show_file_info(e){var t=e.get_details();document.getElementById("name").textContent=t.name,document.getElementById("size").textContent=t.size,document.getElementById("mtime").textContent=t.mtime,document.getElementById("files_remaining").textContent=t.files_remaining,document.getElementById("bytes_remaining").textContent=t.bytes_remaining,document.getElementById("mode").textContent="0"+t.mode.toString(8);var n=e.get_options();["conversion","management","transport","sparse"].forEach(e=>{document.getElementById(`zfile_${e}`).textContent=n[e]}),document.getElementById("zm_file").style.display=""}function _hide_file_info(){document.getElementById("zm_file").style.display="none"}function _save_to_disk(e,t){return Zmodem.Browser.save_to_disk(t,e.get_details().name)}colsElement.addEventListener("change",setTerminalSize),rowsElement.addEventListener("change",setTerminalSize),actionElements.findNext.addEventListener("keypress",function(e){"Enter"===e.key&&(e.preventDefault(),term.findNext(actionElements.findNext.value))}),actionElements.findPrevious.addEventListener("keypress",function(e){"Enter"===e.key&&(e.preventDefault(),term.findPrevious(actionElements.findPrevious.value))}),optionElements.cursorBlink.addEventListener("change",function(){term.setOption("cursorBlink",optionElements.cursorBlink.checked)}),optionElements.cursorStyle.addEventListener("change",function(){term.setOption("cursorStyle",optionElements.cursorStyle.value)}),optionElements.bellStyle.addEventListener("change",function(){term.setOption("bellStyle",optionElements.bellStyle.value)}),optionElements.scrollback.addEventListener("change",function(){term.setOption("scrollback",parseInt(optionElements.scrollback.value,10))}),optionElements.tabstopwidth.addEventListener("change",function(){term.setOption("tabStopWidth",parseInt(optionElements.tabstopwidth.value,10))}),createTerminal();var skipper_button=document.getElementById("zm_progress_skipper"),skipper_button_orig_text=skipper_button.textContent;function _show_progress(){skipper_button.disabled=!1,skipper_button.textContent=skipper_button_orig_text,document.getElementById("bytes_received").textContent=0,document.getElementById("percent_received").textContent=0,document.getElementById("zm_progress").style.display=""}function _update_progress(e){var t=e.get_offset();document.getElementById("bytes_received").textContent=t;var n=100*t/e.get_details().size;document.getElementById("percent_received").textContent=n.toFixed(2)}function _hide_progress(){document.getElementById("zm_progress").style.display="none"}var current_receive_xfer,start_form=document.getElementById("zm_start");function _auto_zmodem(){return document.getElementById("zmodem-auto").checked}function _handle_receive_session(e){e.on("offer",function(e){current_receive_xfer=e,_show_file_info(e);var t=document.getElementById("zm_offer");function n(){if(t.style.display="none",_auto_zmodem()||document.getElementById("zmaccept_yes").checked){_show_progress();var n=[];e.on("input",t=>{_update_progress(e),n.push(new Uint8Array(t))}),e.accept().then(()=>{_save_to_disk(e,n)},console.error.bind(console))}else e.skip()}_auto_zmodem()?n():(t.onsubmit=n,t.style.display="")});var t=new Promise(t=>{e.on("session_end",()=>{_hide_file_info(),_hide_progress(),t()})});return e.start(),t}function _handle_send_session(e){var t=document.getElementById("zm_choose");t.style.display="";var n=document.getElementById("zm_files");return new Promise(o=>{n.onchange=function(r){t.style.display="none";var i=n.files;Zmodem.Browser.send_files(e,i,{on_offer_response(e,t){t&&_show_progress()},on_progress(e,t){_update_progress(t)},on_file_complete(e){_hide_progress()}}).then(_hide_progress).then(e.close.bind(e),console.error.bind(console)).then(()=>{_hide_file_info(),_hide_progress(),o()})}})}function skip_current_file(){current_receive_xfer.skip(),skipper_button.disabled=!0,skipper_button.textContent="Waiting for server to acknowledge skip â€¦"}function runRealTerminal(){term.attach(socket),term._initialized=!0}function runFakeTerminal(){if(!term._initialized){term._initialized=!0;term.prompt=function(){term.write("\r\n$ ")},term.writeln("Welcome to xterm.js"),term.writeln("This is a local terminal emulation, without a real terminal in the back-end."),term.writeln("Type some keys and commands to play around."),term.writeln(""),term.prompt(),term.on("key",function(e,t){var n=!(t.altKey||t.altGraphKey||t.ctrlKey||t.metaKey);13==t.keyCode?term.prompt():8==t.keyCode?term.x>2&&term.write("\b \b"):n&&term.write(e)}),term.on("paste",function(e,t){term.write(e)})}}