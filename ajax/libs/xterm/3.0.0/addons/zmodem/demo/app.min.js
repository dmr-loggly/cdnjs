var express=require("express"),app=express(),expressWs=require("express-ws")(app),os=require("os"),pty=require("node-pty"),terminals={},logs={};app.use("/build",express.static(__dirname+"/../../../../build")),app.use("/demo",express.static(__dirname+"/../../../../demo")),app.use("/zmodemjs",express.static(__dirname+"/../../../../node_modules/zmodem.js/dist")),app.get("/",function(e,s){s.sendFile(__dirname+"/index.html")}),app.get("/style.css",function(e,s){s.sendFile(__dirname+"/style.css")}),app.get("/main.js",function(e,s){s.sendFile(__dirname+"/main.js")}),app.post("/terminals",function(e,s){var n=parseInt(e.query.cols),o=parseInt(e.query.rows),t=pty.spawn("win32"===process.platform?"cmd.exe":"bash",[],{encoding:null,name:"xterm-color",cols:n||80,rows:o||24,cwd:process.env.PWD,env:process.env});console.log("Created terminal with PID: "+t.pid),terminals[t.pid]=t,logs[t.pid]="",t.on("data",function(e){logs[t.pid]+=e}),s.send(t.pid.toString()),s.end()}),app.post("/terminals/:pid/size",function(e,s){var n=parseInt(e.params.pid),o=parseInt(e.query.cols),t=parseInt(e.query.rows);terminals[n].resize(o,t),console.log("Resized terminal "+n+" to "+o+" cols and "+t+" rows."),s.end()}),app.ws("/terminals/:pid",function(s,e){var n=terminals[parseInt(e.params.pid)];console.log("Connected to terminal "+n.pid),s.send(logs[n.pid]),n.on("data",function(e){try{s.send(e)}catch(e){}}),s.on("message",function(e){n.write(e)}),s.on("close",function(){n.kill(),console.log("Closed terminal "+n.pid),delete terminals[n.pid],delete logs[n.pid]})});var port=process.env.PORT||3e3,host="win32"===os.platform()?"127.0.0.1":"0.0.0.0";console.log("App listening to http://"+host+":"+port),app.listen(port,host);