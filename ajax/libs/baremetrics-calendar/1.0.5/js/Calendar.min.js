"use strict";!function(t,e){"function"==typeof define&&define.amd?define(["jquery","moment"],e):"object"==typeof exports?module.exports=e(require("jquery"),require("moment")):t.Calendar=e(jQuery,moment)}(this,function(c,f){function t(t){var d=this;this.calIsOpen=!1,this.presetIsOpen=!1,this.sameDayRange=t.same_day_range||!1,this.element=t.element||c(".daterange"),this.selected=null,this.type=this.element.hasClass("daterange--single")?"single":"double",this.required=0!=t.required,this.format=t.format||{},this.format.input=t.format&&t.format.input||"MMMM D, YYYY",this.format.preset=t.format&&t.format.preset||"ll",this.format.jump_month=t.format&&t.format.jump_month||"MMMM",this.format.jump_year=t.format&&t.format.jump_year||"YYYY",this.days_array=t.days_array&&7==t.days_array.length?t.days_array:["S","M","T","W","T","F","S"],this.orig_start_date=null,this.orig_end_date=null,this.orig_current_date=null,this.earliest_date=t.earliest_date?f(new Date(t.earliest_date)).startOf("day"):f(new Date("January 1, 1900")).startOf("day"),this.latest_date=t.latest_date?f(new Date(t.latest_date)).startOf("day"):f(new Date("December 31, 2900")).startOf("day"),this.end_date=t.end_date?new Date(t.end_date):"double"==this.type?new Date:null,this.start_date=t.start_date?new Date(t.start_date):"double"==this.type?new Date(f(this.end_date).subtract(1,"month")):null,this.current_date=t.current_date?new Date(t.current_date):"single"==this.type?new Date:null,this.callback=t.callback||this.calendarSetDates,this.calendarHTML(this.type),c(".dr-presets",this.element).click(function(){d.presetToggle()}),c(".dr-list-item",this.element).click(function(){var t=c(".dr-item-aside",this).data("start"),e=c(".dr-item-aside",this).data("end");d.start_date=d.calendarCheckDate(t),d.end_date=d.calendarCheckDate(e),d.calendarSetDates(),d.presetToggle(),d.calendarSaveDates()}),c(".dr-date",this.element).on({click:function(){d.calendarOpen(this)},keyup:function(t){9!=t.keyCode||d.calIsOpen||d.start_date||d.end_date||d.calendarOpen(this)},keydown:function(t){switch(t.keyCode){case 9:c(d.selected).hasClass("dr-date-start")?(t.preventDefault(),d.calendarCheckDates(),d.calendarSetDates(),c(".dr-date-end",d.element).trigger("click")):(d.calendarCheckDates(),d.calendarSetDates(),d.calendarSaveDates(),d.calendarClose("force"));break;case 13:t.preventDefault(),d.calendarCheckDates(),d.calendarSetDates(),d.calendarSaveDates(),d.calendarClose("force");break;case 27:d.calendarSetDates(),d.calendarClose("force");break;case 38:t.preventDefault();var e="day";t.shiftKey&&(e="week"),t.metaKey&&(e="month");var a=f(d.current_date).subtract(1,e);c(this).html(a.format(d.format.input)),d.current_date=a._d;break;case 40:t.preventDefault();e="day";t.shiftKey&&(e="week"),t.metaKey&&(e="month");var s=f(d.current_date).add(1,e);c(this).html(s.format(d.format.input)),d.current_date=s._d}}}),c(".dr-month-switcher i",this.element).click(function(){var t=c(".dr-month-switcher span",d.element).data("month"),e=c(".dr-year-switcher span",d.element).data("year"),a=f([e,t,1]),s=a.clone().subtract(1,"month"),r=a.clone().add(1,"month").startOf("day");c(this).hasClass("dr-left")?d.calendarOpen(d.selected,s):c(this).hasClass("dr-right")&&d.calendarOpen(d.selected,r)}),c(".dr-year-switcher i",this.element).click(function(){var t=c(".dr-month-switcher span",d.element).data("month"),e=c(".dr-year-switcher span",d.element).data("year"),a=f([e,t,1]),s=a.clone().subtract(1,"year"),r=a.clone().add(1,"year").startOf("day");c(this).hasClass("dr-left")?d.calendarOpen(d.selected,s):c(this).hasClass("dr-right")&&d.calendarOpen(d.selected,r)}),c(".dr-dates-dash",this.element).click(function(){c(".dr-date-start",d.element).trigger("click")}),c(this.element).click(function(t){c("html").one("click",function(){d.presetIsOpen&&d.presetToggle(),d.calIsOpen&&(c(d.selected).hasClass("dr-date-end")&&d.calendarSaveDates(),d.calendarSetDates(),d.calendarClose("force"))}),t.stopPropagation()}),c(this.element).add(".dr-date",this.element).focus(function(t){c(window).one("click",function(){d.calIsOpen&&(d.calendarSetDates(),d.calendarClose("force"))}),t.stopPropagation()})}return t.prototype.presetToggle=function(){0==this.presetIsOpen?(this.orig_start_date=this.start_date,this.orig_end_date=this.end_date,this.orig_current_date=this.current_date,this.presetIsOpen=!0,this.presetCreate()):this.presetIsOpen&&(this.presetIsOpen=!1),1==this.calIsOpen&&this.calendarClose(),c(".dr-preset-list",this.element).slideToggle(200),c(".dr-input",this.element).toggleClass("dr-active"),c(".dr-presets",this.element).toggleClass("dr-active")},t.prototype.presetCreate=function(){var e,a=this,s=this.latest_date,r=f(s).endOf("month"),d=r.isSame(s);c(".dr-list-item",this.element).each(function(){var t=c(this).data("months");if(d||(r=f(s).subtract(1,"month").endOf("month").startOf("day")),"number"==typeof t?(e=f(s).subtract(d?t-1:t,"month").startOf("month"),12==t&&(e=f(s).subtract(d?11:12,"month").startOf("month").startOf("day"))):(e="all"==t?f(a.earliest_date):f(a.latest_date).subtract(29,"day"),r=f(a.latest_date)),e.isBefore(a.earliest_date))return c(this).remove();c(".dr-item-aside",this).data("start",e.toISOString()).data("end",r.toISOString()).html(e.format(a.format.preset)+" &ndash; "+r.format(a.format.preset))})},t.prototype.calendarSetDates=function(){if(c(".dr-date-start",this.element).html(f(this.start_date).format(this.format.input)),c(".dr-date-end",this.element).html(f(this.end_date).format(this.format.input)),!this.start_date&&!this.end_date){var t=c(".dr-date",this.element).html(),e=f(this.current_date).format(this.format.input);0!=t.length||this.required||(e=""),t!=e&&c(".dr-date",this.element).html(e)}},t.prototype.calendarSaveDates=function(){if("double"==this.type){if(!f(this.orig_end_date).isSame(this.end_date)||!f(this.orig_start_date).isSame(this.start_date))return this.callback()}else if(c(this.selected).html().length&&!f(this.orig_current_date).isSame(this.current_date))return this.callback()},t.prototype.calendarCheckDate=function(t){var e=t?t.replace(/(?!<=\d)(st|nd|rd|th)/,"").split(" "):[];if("today"!=t&&"now"!=t||(t=f().isAfter(this.latest_date)?this.latest_date:f()),"earliest"==t&&(t=this.earliest_date),"latest"==t&&(t=this.latest_date),!t||-1==t.toString().indexOf("ago")&&-1==t.toString().indexOf("ahead")||(t=this.stringToDate(t)),2==e.length&&(e.push(f().format(this.display_year_format)),t=e.join(" ")),t&&"string"==c.type(t)){var a=f(t,this.format.input);a.isValid()&&(t=a)}return new Date(t)},t.prototype.calendarCheckDates=function(){var t=c(".dr-date-start",this.element).html(),e=c(".dr-date-end",this.element).html(),a=c(this.selected).html();if("ytd"==t||"ytd"==e?(t=f().startOf("year"),e=f().isAfter(this.latest_date)?this.latest_date:f()):(t=this.calendarCheckDate(t),e=this.calendarCheckDate(e)),a=this.calendarCheckDate(a),f(a).isSame(t)&&f(t).isAfter(e)&&(e=f(t).add(6,"day")),f(a).isSame(e)&&f(e).isBefore(t)&&(t=f(e).subtract(6,"day")),(f(e).isBefore(this.earliest_date)||f(t).isBefore(this.earliest_date))&&(t=f(this.earliest_date),e=f(this.earliest_date).add(6,"day")),(f(e).isAfter(this.latest_date)||f(t).isAfter(this.latest_date))&&(t=f(this.latest_date).subtract(6,"day"),e=f(this.latest_date)),f(t).isSame(e)&&!this.sameDayRange)return this.calendarSetDates();this.start_date="Invalid Date"==t?this.start_date:t,this.end_date="Invalid Date"==e?this.end_date:e,this.current_date="Invalid Date"==a?this.current_date:a},t.prototype.stringToDate=function(t){var e=t.split(" ");return"ago"==e[2]?f(this.current_date).subtract(e[0],e[1]):"ahead"==e[2]?f(this.current_date).add(e[0],e[1]):this.current_date},t.prototype.calendarOpen=function(t,e){var i,n=this,a=c(".dr-dates",this.element).innerWidth()-8;this.selected=t||this.selected,1==this.presetIsOpen&&this.presetToggle(),1==this.calIsOpen?this.calendarClose(e?"switcher":void 0):c(this.selected).html().length&&(this.orig_start_date=this.start_date,this.orig_end_date=this.end_date,this.orig_current_date=this.current_date),this.calendarCheckDates(),this.calendarCreate(e),this.calendarSetDates();var s=f(e||this.current_date).add(1,"month").startOf("month").startOf("day"),r=f(e||this.current_date).subtract(1,"month").endOf("month"),d=f(e||this.current_date).add(1,"year").startOf("month").startOf("day"),l=f(e||this.current_date).subtract(1,"year").endOf("month"),h=f(e||this.current_date);c(".dr-month-switcher span",this.element).data("month",h.month()).html(h.format(this.format.jump_month)),c(".dr-year-switcher span",this.element).data("year",h.year()).html(h.format(this.format.jump_year)),c(".dr-switcher i",this.element).removeClass("dr-disabled"),s.isAfter(this.latest_date)&&c(".dr-month-switcher .dr-right",this.element).addClass("dr-disabled"),r.isBefore(this.earliest_date)&&c(".dr-month-switcher .dr-left",this.element).addClass("dr-disabled"),d.isAfter(this.latest_date)&&c(".dr-year-switcher .dr-right",this.element).addClass("dr-disabled"),l.isBefore(this.earliest_date)&&c(".dr-year-switcher .dr-left",this.element).addClass("dr-disabled"),c(".dr-day",this.element).on({mouseenter:function(){var d=c(this);f(n.start_date),f(n.end_date),f(n.current_date);function t(r){i=void 0,n.range(42).forEach(function(t){var e=d.next().data("date"),a=d.prev().data("date"),s=d.data("date");if(!s)return!1;if(a||(a=s),e||(e=s),"start"==r){if(f(e).isSame(n.end_date)||n.sameDayRange&&f(s).isSame(n.end_date))return!1;if(f(s).isAfter(n.end_date)&&(i=i||f(s).add(6,"day").startOf("day"),5<t||e&&f(e).isAfter(n.latest_date)))return c(d).addClass("dr-end"),i=f(s),!1;d=d.next().addClass("dr-maybe")}else if("end"==r){if(f(a).isSame(n.start_date)||n.sameDayRange&&f(s).isSame(n.start_date))return!1;if(f(s).isBefore(n.start_date)&&(i=i||f(s).subtract(6,"day"),5<t||a&&f(a).isBefore(n.earliest_date)))return c(d).addClass("dr-start"),i=f(s),!1;d=d.prev().addClass("dr-maybe")}})}c(n.selected).hasClass("dr-date-start")&&(d.addClass("dr-hover dr-hover-before"),c(".dr-start",n.element).css({border:"none","padding-left":"0.3125rem"}),t("start")),c(n.selected).hasClass("dr-date-end")&&(d.addClass("dr-hover dr-hover-after"),c(".dr-end",n.element).css({border:"none","padding-right":"0.3125rem"}),t("end")),n.start_date||n.end_date||d.addClass("dr-maybe"),c(".dr-selected",n.element).css("background-color","transparent")},mouseleave:function(){c(this).hasClass("dr-hover-before dr-end")&&c(this).removeClass("dr-end"),c(this).hasClass("dr-hover-after dr-start")&&c(this).removeClass("dr-start"),c(this).removeClass("dr-hover dr-hover-before dr-hover-after"),c(".dr-start, .dr-end",n.element).css({border:"",padding:""}),c(".dr-maybe:not(.dr-current)",n.element).removeClass("dr-start dr-end"),c(".dr-day",n.element).removeClass("dr-maybe"),c(".dr-selected",n.element).css("background-color","")},mousedown:function(){var t=c(this).data("date"),e=f(t).format(n.format.input);i&&c(".dr-date",n.element).not(n.selected).html(i.format(n.format.input)),c(n.selected).html(e),n.calendarOpen(n.selected),c(n.selected).hasClass("dr-date-start")?c(".dr-date-end",n.element).trigger("click"):(n.calendarSaveDates(),n.calendarClose("force"))}}),c(".dr-calendar",this.element).css("width",a).slideDown(200),c(".dr-input",this.element).addClass("dr-active"),c(t).addClass("dr-active").focus(),c(this.element).addClass("dr-active"),this.calIsOpen=!0},t.prototype.calendarClose=function(t){var e=this;if(!this.calIsOpen||this.presetIsOpen||"force"==t?c(".dr-calendar",this.element).slideUp(200,function(){c(".dr-day",e.element).remove()}):c(".dr-day",this.element).remove(),"switcher"==t)return!1;c(".dr-input, .dr-date",this.element).removeClass("dr-active"),c(this.element).removeClass("dr-active"),this.calIsOpen=!1},t.prototype.calendarCreate=function(t){var s=this;this.calendarArray(this.start_date,this.end_date,this.current_date,t).forEach(function(t,e){var a="dr-day";t.fade&&(a+=" dr-fade"),t.start&&(a+=" dr-start"),t.end&&(a+=" dr-end"),t.current&&(a+=" dr-current"),t.selected&&(a+=" dr-selected"),t.outside&&(a+=" dr-outside"),c(".dr-day-list",s.element).append('<li class="'+a+'" data-date="'+t.date+'">'+t.str+"</li>")})},t.prototype.calendarArray=function(t,e,a,s){var r=this;a=f(a||t||e).startOf("day");var d=f(s||a).startOf("month"),i=f(s||a).endOf("month"),n={start:{day:+d.format("d"),str:+d.format("D")},end:{day:+i.format("d"),str:+i.format("D")}},l=void 0,h=this.range(n.start.day).map(function(){return null==l&&(l=f(d)),{str:+(l=l.subtract(1,"day")).format("D"),start:l.isSame(t),end:l.isSame(e),current:l.isSame(a),selected:l.isBetween(t,e),date:l.toISOString(),outside:l.isBefore(r.earliest_date),fade:!0}}).reverse(),c=42-(n.end.str+h.length);l=void 0;var o=this.range(c).map(function(){return null==l&&(l=f(i)),{str:+(l=l.add(1,"day").startOf("day")).format("D"),start:l.isSame(t),end:l.isSame(e),current:l.isSame(a),selected:l.isBetween(t,e),date:l.toISOString(),outside:l.isAfter(r.latest_date),fade:!0}});l=void 0;var m=this.range(n.end.str).map(function(){return{str:+(l=null==l?f(d):l.add(1,"day").startOf("day")).format("D"),start:l.isSame(t),end:l.isSame(e),current:l.isSame(a),selected:l.isBetween(t,e),date:l.toISOString(),outside:l.isBefore(r.earliest_date)||l.isAfter(r.latest_date),fade:!1}});return h.concat(m,o)},t.prototype.calendarHTML=function(t){var a=c('<ul class="dr-days-of-week-list"></ul>');return c.each(this.days_array||f.weekdaysMin(),function(t,e){a.append('<li class="dr-day-of-week">'+e+"</li>")}),"double"==t?this.element.append('<div class="dr-input"><div class="dr-dates"><div class="dr-date dr-date-start" contenteditable>'+f(this.start_date).format(this.format.input)+'</div><span class="dr-dates-dash">&ndash;</span><div class="dr-date dr-date-end" contenteditable>'+f(this.end_date).format(this.format.input)+'</div></div><div class="dr-presets"><span class="dr-preset-bar"></span><span class="dr-preset-bar"></span><span class="dr-preset-bar"></span></div></div><div class="dr-selections"><div class="dr-calendar" style="display: none;"><div class="dr-range-switcher"><div class="dr-switcher dr-month-switcher"><i class="dr-left"></i><span>April</span><i class="dr-right"></i></div><div class="dr-switcher dr-year-switcher"><i class="dr-left"></i><span>2015</span><i class="dr-right"></i></div></div>'+a[0].outerHTML+'<ul class="dr-day-list"></ul></div><ul class="dr-preset-list" style="display: none;"><li class="dr-list-item" data-months="days">Last 30 days <span class="dr-item-aside"></span></li><li class="dr-list-item" data-months="1">Last month <span class="dr-item-aside"></span></li><li class="dr-list-item" data-months="3">Last 3 months <span class="dr-item-aside"></span></li><li class="dr-list-item" data-months="6">Last 6 months <span class="dr-item-aside"></span></li><li class="dr-list-item" data-months="12">Last year <span class="dr-item-aside"></span></li><li class="dr-list-item" data-months="all">All time <span class="dr-item-aside"></span></li></ul></div>'):this.element.append('<div class="dr-input"><div class="dr-dates"><div class="dr-date" contenteditable placeholder="'+this.format.input+'">'+(this.required?f(this.current_date).format(this.format.input):"")+'</div></div></div><div class="dr-selections"><div class="dr-calendar" style="display: none;"><div class="dr-range-switcher"><div class="dr-switcher dr-month-switcher"><i class="dr-left"></i><span></span><i class="dr-right"></i></div><div class="dr-switcher dr-year-switcher"><i class="dr-left"></i><span></span><i class="dr-right"></i></div></div>'+a[0].outerHTML+'<ul class="dr-day-list"></ul></div></div>')},t.prototype.range=function(t){for(var e=new Array(t),a=0;a<t;a++)e[a]=a;return e},t});